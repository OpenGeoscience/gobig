---
  - name: girder | add | node repository
    shell: "curl -sL https://deb.nodesource.com/setup | sudo bash -"

  - name: girder | deps | install
    apt: name={{ item }} state=present update_cache=yes
    with_items:
      - curl
      - g++
      - git
      - libffi-dev
      - make
      - python-dev
      - python-pip
      - nodejs
      - python-virtualenv
    when: do_install|bool

  - name: grunt-cli | install
    npm:
        name: "{{ item }}"
        global: yes
    with_items:
      - grunt
      - grunt-cli
    when: do_install|bool

  - name: girder | service | stop
    service:
        name: girder
        state: stopped
    ignore_errors: true
    when: stop_services|bool

  - name: girder | install root | delete
    file:
        path: "{{ girder_install_root }}"
        state: absent
    when: remove_install_root|bool

  - name: girder | data root | delete
    file:
        path: "{{ girder_data_root }}"
        state: absent
    when: remove_data_root|bool

  - name: girder | install parent | create
    file:
        path: "{{ girder_install_parent }}"
        owner: "{{ girder_user }}"
        group: "{{ girder_group }}"
        state: directory
    when: do_install|bool

  - name: girder | data root | create
    file:
        path: "{{ girder_data_root }}"
        state: directory
        group: "{{ girder_group }}"
        owner: "{{ girder_user }}"
        mode: 0755
    when: do_install|bool

  - name: girder | install root | create
    file:
        path: "{{ girder_install_root }}"
        state: directory
        group: "{{ girder_group }}"
        owner: "{{ girder_user }}"
        mode: 0755
    when: do_install|bool

  - name: girder | venv root | create
    file:
        path: "{{ girder_venv_root }}"
        state: directory
        group: "{{ girder_group }}"
        owner: "{{ girder_user }}"
        mode: 0755
    when: do_install|bool


  - name: girder | repo | sync
    command: >
        rsync -avz --exclude=.git
        "{{ girder_git_work_dir }}/"
        "{{ girder_install_root }}/"
    when: do_install|bool
    become: yes
    become_user: "{{ girder_user }}"

  - name: Install editable version of girder
    pip:
      chdir: "{{ girder_install_root }}"
      virtualenv: "{{ girder_venv_root }}"
      extra_args: "-e"
      name: "."
    become: yes
    become_user: "{{ girder_user }}"
    when: do_install|bool

  - name: girder | conf | owner | set
    file:
        recurse: yes
        path: "{{ girder_install_root }}"
        owner: "{{ girder_user }}"
        group: "{{ girder_group }}"
    when: do_install|bool

  - name: Install frontend assets
    shell: ". {{girder_venv_root}}/bin/activate && girder-install web"
    args:
      chdir: "{{ girder_install_root }}"
    become: yes
    become_user: "{{ girder_user }}"

  - name: girder | conf | girder.local.cfg | generate
    template:
        src: girder.local.cfg.j2
        dest: "{{ girder_install_root }}/girder/conf/girder.local.cfg"
        owner: "{{ girder_user }}"
        group: "{{ girder_group }}"
        mode: 0644
    when: do_install|bool
    become: yes
    become_user: "{{ girder_user }}"
